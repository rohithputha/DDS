version: '3.8'

services:
  weaviate:
    image: semitechnologies/weaviate:1.27.0
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      DEFAULT_VECTORIZER_MODULE: 'none'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
    volumes:
      - weaviate-data:/var/lib/weaviate
  
  ollama:
    image: ollama/ollama
    ports:
      - "11434:11434"
  # -------------------------------------------
  # 1. Config Server Replica Set (3 nodes for HA)
  # -------------------------------------------
  configsvr-1:
    image: mongo:latest
    container_name: mongo-configsvr-1
    command: ["mongod", "--configsvr", "--replSet", "rs-config", "--port", "27017"]
    volumes:
      - config-data-1:/data/db
  configsvr-2:
    image: mongo:latest
    container_name: mongo-configsvr-2
    command: ["mongod", "--configsvr", "--replSet", "rs-config", "--port", "27017"]
    volumes:
      - config-data-2:/data/db
  configsvr-3:
    image: mongo:latest
    container_name: mongo-configsvr-3
    command: ["mongod", "--configsvr", "--replSet", "rs-config", "--port", "27017"]
    volumes:
      - config-data-3:/data/db

  # -------------------------------------------
  # 2. Shard A Replica Set (1 Primary, 2 Replicas)
  # -------------------------------------------
  shard-a-1:
    image: mongo:latest
    container_name: mongo-shard-a-1
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-a", "--port", "27017"]
    volumes:
      - shard-a-data-1:/data/db
  shard-a-2:
    image: mongo:latest
    container_name: mongo-shard-a-2
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-a", "--port", "27017"]
    volumes:
      - shard-a-data-2:/data/db
  shard-a-3:
    image: mongo:latest
    container_name: mongo-shard-a-3
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-a", "--port", "27017"]
    volumes:
      - shard-a-data-3:/data/db

  # -------------------------------------------
  # 3. Shard B Replica Set (1 Primary, 2 Replicas)
  # -------------------------------------------
  shard-b-1:
    image: mongo:latest
    container_name: mongo-shard-b-1
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-b", "--port", "27017"]
    volumes:
      - shard-b-data-1:/data/db
  shard-b-2:
    image: mongo:latest
    container_name: mongo-shard-b-2
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-b", "--port", "27017"]
    volumes:
      - shard-b-data-2:/data/db
  shard-b-3:
    image: mongo:latest
    container_name: mongo-shard-b-3
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-b", "--port", "27017"]
    volumes:
      - shard-b-data-3:/data/db

  # -------------------------------------------
  # 4. Shard C Replica Set (1 Primary, 2 Replicas)
  # -------------------------------------------
  shard-c-1:
    image: mongo:latest
    container_name: mongo-shard-c-1
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-c", "--port", "27017"]
    volumes:
      - shard-c-data-1:/data/db
  shard-c-2:
    image: mongo:latest
    container_name: mongo-shard-c-2
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-c", "--port", "27017"]
    volumes:
      - shard-c-data-2:/data/db
  shard-c-3:
    image: mongo:latest
    container_name: mongo-shard-c-3
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-c", "--port", "27017"]
    volumes:
      - shard-c-data-3:/data/db

  # -------------------------------------------
  # 5. Shard D Replica Set (1 Primary, 2 Replicas)
  # -------------------------------------------
  shard-d-1:
    image: mongo:latest
    container_name: mongo-shard-d-1
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-d", "--port", "27017"]
    volumes:
      - shard-d-data-1:/data/db
  shard-d-2:
    image: mongo:latest
    container_name: mongo-shard-d-2
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-d", "--port", "27017"]
    volumes:
      - shard-d-data-2:/data/db
  shard-d-3:
    image: mongo:latest
    container_name: mongo-shard-d-3
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-d", "--port", "27017"]
    volumes:
      - shard-d-data-3:/data/db

  # -------------------------------------------
  # 6. Shard E Replica Set (1 Primary, 2 Replicas)
  # -------------------------------------------
  shard-e-1:
    image: mongo:latest
    container_name: mongo-shard-e-1
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-e", "--port", "27017"]
    volumes:
      - shard-e-data-1:/data/db
  shard-e-2:
    image: mongo:latest
    container_name: mongo-shard-e-2
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-e", "--port", "27017"]
    volumes:
      - shard-e-data-2:/data/db
  shard-e-3:
    image: mongo:latest
    container_name: mongo-shard-e-3
    command: ["mongod", "--shardsvr", "--replSet", "rs-shard-e", "--port", "27017"]
    volumes:
      - shard-e-data-3:/data/db

  # -------------------------------------------
  # 7. The `mongos` Router (Front Door)
  # -------------------------------------------
  router:
    image: mongo:latest
    container_name: mongo-router
    command: >
      bash -c "
        # Wait for the config servers to be ready
        sleep 15;
        mongos --configdb rs-config/mongo-configsvr-1:27017,mongo-configsvr-2:27017,mongo-configsvr-3:27017 --bind_ip_all
      "
    ports:
      - "27017:27017" # The ONLY port you connect to
    depends_on:
      - configsvr-1
      - configsvr-2
      - configsvr-3
      - shard-a-1
      - shard-a-2
      - shard-a-3
      - shard-b-1
      - shard-b-2
      - shard-b-3
      - shard-c-1
      - shard-c-2
      - shard-c-3
      - shard-d-1
      - shard-d-2
      - shard-d-3
      - shard-e-1
      - shard-e-2
      - shard-e-3

# -------------------------------------------
# Volumes for Data Persistence (18 total)
# -------------------------------------------
volumes:
  config-data-1:
  config-data-2:
  config-data-3:
  shard-a-data-1:
  shard-a-data-2:
  shard-a-data-3:
  shard-b-data-1:
  shard-b-data-2:
  shard-b-data-3:
  shard-c-data-1:
  shard-c-data-2:
  shard-c-data-3:
  shard-d-data-1:
  shard-d-data-2:
  shard-d-data-3:
  shard-e-data-1:
  shard-e-data-2:
  shard-e-data-3:
  weaviate-data: